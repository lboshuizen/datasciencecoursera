---
title: "Roparun App"
author: "L. Boshuizen"
date: "3/4/2021"
output: 
    ioslides_presentation: 
        incremental: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(plotly)
library(lubridate)
library(jsonlite)
library(dplyr)
library(leaflet)
library(ggplot2)
library(ggthemes)
library(scales)

teams <- fromJSON("./data/teams.json", flatten=TRUE)

# only 2 contenders from Almelo NL, dropped
teams <- teams[teams$route != "A",]
positions <- fromJSON("./data/positions.json", flatten=TRUE)

# data conversions
teams$start <- as_datetime(teams$start)
positions$passed <- as_datetime(positions$passed)

# filter only official checkpoints. Teams are allowed to send intermediate checkpoints using text-messages. The freq is low and adds to much noise to be meaningfull.
markers <- positions %>% group_by(position) %>% tally() %>% ungroup() %>% filter(n > 80)
positions <- positions[ positions$position %in% markers$position, ] %>% mutate( position=position/10)

# calculate average speed between checkpoints
positions <- positions[order(positions$position),] %>% group_by(teamId) %>% mutate(duration = as.numeric(as.duration(passed - lag(passed)),"hour"), length = position-lag(position), speed=length/duration) %>% ungroup() %>% filter( speed < 25 & speed > 3 )

pal = economist_pal()(16)
pal_fill = economist_pal(fill=T)(16)
```

## Introduction

The Roparun is a relay race of over 500 kilometres from Paris (FR) and Bremen (G) to Rotterdam (NL), where people in teams, take part in an athletic event to raise money for people with cancer.

It’s also called an adventure for life. 
This is also clear from the motto, which for years has been:<br /> _‘Adding life to days, when days often can’t be added to life’._

More info: [www.roparun.nl](https://roparun.nl/en/over-roparun/)

_notes:_ 

<small> _starting point in Germany was Hamburg in 2019_ </small>

_due to CV-19 there are no races in 2020 and 2021_

## Current Solution

> - MS Excel

> - Manual import of new data

> - Tedious updating of tables & figures

> - Prone to errors

> - Delay in distribution

## Proposed Solution

  - Automatic (realtime) import of data
  
  - Zero delay in distribution
  
  - Interactive
  
  - Extensible 

## Implemented Features

> - Interactive filters:

> - Route

> - Estimated average speed 

> - Statistics about start & Finish

> - Statistics about progress of teams

## Examples

```{r echo=F, message=F}
  df <- teams[ teams$route == "P",]
  p <- ggplot(data=df,aes(x=start, color=speed)) + geom_histogram(fill=pal[1]) + labs(title="Starting times of teams", x="Time", y="Count") + scale_x_datetime(breaks = date_breaks("60 min"),labels = date_format("%H:%M")) + theme_minimal()
  ggplotly(p)
```

---

```{r echo=F, message=F}
  df <- teams[ teams$route == "P",]
  df <- positions[ positions$teamId %in% df$teamId, ] %>% group_by(position) %>% summarise(avg=mean(speed))
  p <- ggplot(data=df,aes(x=position,y=avg)) + geom_point(colour=pal[2]) + geom_smooth(color = pal[1], fill=pal_fill[1]) + labs(title="Avg speed at checkpoints", x="Position (km)", y="Speed (km/h)") + theme_minimal()
  ggplotly(p)
```


